---
title: "Guided Project: Answering Business Questions with RSQLite"
output: html_notebook
---

```{r}
library(RSQLite)
library(DBI)

db <- "chinook.db"
conn <- dbConnect(SQLite(), db)
tables <- dbListTables(conn)

```
Make helper functions:
```{r helper}
run_query <- function(query) {
  conn <- dbConnect(SQLite(), db)
  result <- dbGetQuery(conn, query)
 # dbDisconnect(conn)
  return(result)
}

show_tables <- function(){
   query <- "SELECT name, type FROM sqlite_master WHERE type IN ('table', 'view')"
  return(run_query(query))
}

show_tables()

```
Set theme for plots:
```{r}
library(ggplot2)
my_theme <- theme(axis.line.x.bottom = element_line(size = 0.25),
                  axis.line.y.left = element_line(size = 0.25),
                  panel.background = element_rect(fill = "white"),
                  panel.grid = element_blank())

theme_set(my_theme)
```


# The situation:

The Chinook record store has just signed a deal with a new record label, and we are in charge of choosing the first three albums to be added to the store. There are four albums to choose from, and all four are by artists who don't have any tracks in the store right now. Here is the list of artist names and the genre of music they produce:

| Artist name          | Genre   |
|----------------------|---------|
| Regal                | Hip-Hop |
| Red Tone             | Punk    |
| Meteor and the Girls | Pop     |
| Slim Jim Bites       | Blues   |

The record label specializes in artists from the US, so they have given Chinook some money to advertise the new albums in the USA. In order to choose which albums to buy, we need to identify the best-selling genres in the USA. 


# Which new albums should be added?
## 1. Which genres sell the most in the USA?
Solution with SQL query as string: 
```{r sql query genre}
to_purchase <- '
WITH usa_sales AS
   (
    SELECT il.* 
    FROM invoice_line AS il
    INNER JOIN invoice AS i ON il.invoice_id = i.invoice_id
    INNER JOIN customer AS c ON i.customer_id = c.customer_id
    WHERE c.country = "USA"
   )
SELECT
    g.name AS genre,
    count(us.invoice_line_id) AS tracks_sold,
    cast(count(us.invoice_line_id) AS FLOAT)/(
        SELECT COUNT(*) from usa_sales
    ) AS percentage_tracks_sold
FROM usa_sales AS us
INNER JOIN track AS t ON t.track_id = us.track_id
INNER JOIN genre g ON g.genre_id = t.genre_id
GROUP BY genre
ORDER BY percentage_tracks_sold DESC
LIMIT 10;
'
run_query(to_purchase)
```

Solution with SQL chunk:
```{sql connection=conn, output.var="top_10_sales"}
WITH usa_sales AS
   (
    SELECT il.* 
    FROM invoice_line AS il
    INNER JOIN invoice AS i ON il.invoice_id = i.invoice_id
    INNER JOIN customer AS c ON i.customer_id = c.customer_id
    WHERE c.country = "USA"
   )
SELECT
    g.name AS genre,
    count(us.invoice_line_id) AS tracks_sold,
    cast(count(us.invoice_line_id) AS FLOAT)/(
        SELECT COUNT(*) from usa_sales
    ) AS percentage_tracks_sold
FROM usa_sales AS us
INNER JOIN track AS t ON t.track_id = us.track_id
INNER JOIN genre g ON g.genre_id = t.genre_id
GROUP BY genre
ORDER BY percentage_tracks_sold DESC
LIMIT 10;
```

## 2. Plot the data
```{r plot top 10 genres}
library(ggplot2)
# Note that I use the "top_10_sales" variable generated as the output of the SQL chunk above. Without the SQL chunk, the result of run_query(to_purchase) needs to be assigned to a variable so it can be used in R.

top_genres_plot <- ggplot(data = top_10_sales, aes(x = reorder(genre, -percentage_tracks_sold), y = percentage_tracks_sold)) +
  geom_bar(stat = "identity", fill = "orange") +
  xlab("Genre") +
  ylab("Percent of total tracks sold in USA") +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
  

top_genres_plot
```
## Conclusion
It seems that Rock, Alternative & Punk, and Metal are the 3 top-selling music genres in the USA, so we should include the Punk album by Red Tone. However, we don't have any new Rock or Metal albums available, so we should choose the next best genres: Blues and Pop. 

In sum, the following three albums will be recommended:
- Red Tone (Punk)
- Slim Jim Bites (Blues)
- Meteor and the Girls (Pop).

It would be worth asking the record label if they have any new Rock albums, because this genre is overwhelmingly the bestseller.

# Assessment of sales support rep performance
## 1. Gather all potentially relevant data
```{sql connection=conn, output.var="employee_perf"}
WITH sales_per_rep AS 
(
SELECT 
i.customer_id,
c.support_rep_id,
SUM(i.total) AS total_sales
FROM invoice AS i
INNER JOIN customer AS c ON c.customer_id = i.customer_id
GROUP BY 1, 2
)
SELECT 
e.first_name || " " || e.last_name AS employee,
e.reports_to AS supervisor,
e.hire_date AS hire_date,
e.birthdate AS birthdate,
e.country AS country,
SUM(spr.total_sales) as total_sold
FROM sales_per_rep AS spr
INNER JOIN employee AS e ON e.employee_id = spr.support_rep_id
GROUP BY employee;

```

## 2. Plot the data
```{r plot employee perf}
e_perf_plot <- ggplot(data = employee_perf, aes(x = reorder(employee, -total_sold), y = total_sold)) +
  geom_bar(stat = "identity", fill = "cyan3") +
  xlab("Sales Support Rep") +
  ylab("Total sales ($)") 
                       
e_perf_plot                        
```
Jane Peacock has the highest sales amount among the Sales Support Reps. Most of the available employee characteristics are the same between each of the reps, except for date of hire and birthdate. It's unlikely that age has a big impact on their sales, but more experienced employees may sell more due to various factors like increased skill or rapport with clients. 
Let's visualize how long each employee has been with the company:

```{r plot employee time since hire, message=FALSE, warning=FALSE}
library(lubridate) 
library(tidyverse)

hire_timeline <- employee_perf %>%
  select(employee, hire_date, birthdate) %>%
  mutate(hire_date = lubridate::as_date(hire_date),
         time_since_hire = lubridate::today() - hire_date,
         birthdate = lubridate::as_date(birthdate),
         age = (lubridate::today() - birthdate)/365)


plot_time <- ggplot(data = hire_timeline, aes(x = reorder(employee, time_since_hire), y = time_since_hire)) +
  geom_bar(stat = "identity", fill = "sienna1") +
  coord_flip() +
  xlab("Sales Support Rep") +
  ylab("Time since hire (days)") +
  theme(axis.text.y = element_text(angle = 0))
plot_time
```
Let's also look at their respective ages, keeping in mind that we don't know enough about these employees to know what other factors influencing their performance might be correlated with age. This means that even if we find big differences in age, we can't draw any firm conclusions about their relationship to employee sales.

```{r plot age, message=FALSE, warning=FALSE}
age_plot <- ggplot(data = hire_timeline, aes(x = reorder(employee, age), y = age)) +
  geom_bar(stat = "identity", fill = "lightgoldenrod2") +
  coord_flip() +
  xlab("Sales Support Rep") +
  ylab("Age (years)") +
  theme(axis.text.y = element_text(angle = 0))
age_plot

```

## Conclusion:
Jane Peacock has been with the company the longest, but not by much longer than Margaret Park, so it seems unlikely that this has had a significant effect on her performance. She is also the youngest, but Margaret Park is the oldest, yet has the second-highest total dollar amount of sales, so it's also unlikely that age can explain the observed differences in performance. 
A more detailed view of these employees' work patterns, like working hours and total number of days worked, is needed to better explain this variability. 

# Sales for each different country (ignoring country data from invoice table)
## 1. Gather the data
```{sql connection=conn, output.var="sales_bycountry"}
WITH dummy_code AS 
(
SELECT 
     CASE WHEN (
                SELECT COUNT(*) 
                FROM customer AS c
                WHERE country = c.country
                ) = 1 THEN "Other"
          ELSE c.country
    END AS country,
    c.customer_id,
    il.*
FROM invoice_line AS il
INNER JOIN invoice aS i ON i.invoice_id = il.invoice_id
INNER JOIN customer AS c ON c.customer_id = i.customer_id
)

SELECT 
country,
customers,
total_sales,
average_sales_per_c,
average_order_val
FROM 
(
    SELECT 
    country,
    COUNT(DISTINCT customer_id) AS customers,
    SUM(unit_price) AS total_sales,
    SUM(unit_price)/COUNT(DISTINCT customer_id) AS average_sales_per_c,
    SUM(unit_price)/COUNT(DISTINCT invoice_id) AS average_order_val,
    CASE
      WHEN country = "Other" THEN 1
      ELSE 0
    END AS sorting
    FROM dummy_code
    GROUP BY country
    ORDER BY sorting ASC, total_sales DESC
);

```

```{r}
# temporary stopgap to correct "Other" labeling as even solution provided by Dataquest did not work 

sales_bycountry <- sales_bycountry %>% 
  mutate(country = if_else(customers == 1, "Other", country)) 
```

## 2. Plots
Number of customers by country (excluding "Other" countries which had only 1 customer):
```{r plot n_customers, warning=FALSE, message=FALSE}
sales_bycountry_cut <-  sales_bycountry %>% filter(country != "Other")

cust <- ggplot(data = sales_bycountry_cut, aes(x = reorder(country, -customers), y = customers, fill = country)) +
  geom_bar(stat = "identity") + 
  xlab("Country") +
  ylab("Number of customers") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")

cust

```

Total sales by country (again excluding "Other"):
```{r plot sales by country, message=FALSE, warning=FALSE}
tot_sold <- ggplot(data = sales_bycountry_cut, aes(x = reorder(country, -total_sales), y = total_sales, fill = country)) +
  geom_bar(stat = "identity") +
  xlab("Country") +
  ylab("Total sales ($)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")

tot_sold
```
Average sales per customer:
```{r plot avg sales per c, message=FALSE, warning=FALSE}
sales_per_c <- ggplot(data = sales_bycountry_cut, aes(x = reorder(country, -average_sales_per_c), y = average_sales_per_c, fill = country)) +
  geom_bar(stat = "identity") +
  xlab("Country") +
  ylab("Average value of sales per customer ($)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")

sales_per_c
```
Average order value by country:
```{r plot avg order val, message=FALSE, warning=FALSE}
order_val <- ggplot(data = sales_bycountry_cut, aes(x = reorder(country, -average_order_val), y = average_order_val, fill = country)) +
  geom_bar(stat = "identity") +
  xlab("Country") +
  ylab("Average order value ($)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")

order_val

```
# Conclusion
The USA is the biggest market, largely because it has the most customers, as these customers are not the biggest spenders. The data shows that the biggest spenders are in the Czech Republic, where both the average value of sales per customer and the average order value are highest despite it having one of the smallest numbers of customers (though note that the average order value varies relatively little between countries so it might not be the most meaningful metric). 

Based on this data, the Czech Republic seems like a market with potential for growth. Perhaps other countries with few customers but relatively high average sales values per customer and/or order vales (e.g., Portugal, India, United Kingdom) might also be candidates for potential growth, but generally it would be helpful to have more detailed data on customers and their behaviour (e.g., historical changes, demographics) in order to be able to make better recommendations. 

# Should the store continue to buy full albums from record labels?
## 1. Find out how many sales were for full albums versus individual tracks
```{sql, connection=conn, output.var="albums_vs_ind"}
--First, get the first track of each invoice and define new table invoice_first_track (ifs)
WITH invoice_first_track AS
    (
     SELECT
         il.invoice_id invoice_id,
         MIN(il.track_id) first_track_id
     FROM invoice_line il
     GROUP BY 1
    )
SELECT --then select final columns (including is_album which hasn't been defined yet)
    is_album,
    COUNT(invoice_id) n_invoices,
    CAST(count(invoice_id) AS FLOAT) / (SELECT COUNT(*) FROM invoice) percent
FROM --then define the subset of invoice_first_track to select from
    (
    SELECT
        ifs.*, --i.e., all values of ifs where
        CASE
            WHEN
                 (--the difference between the list of tracks corresponding to each invoice in ifs
                  SELECT il2.track_id FROM invoice_line il2
                  WHERE il2.invoice_id = ifs.invoice_id
                   
                  EXCEPT -- and the list of tracks belonging to albums to which tracks in invoice_first_track belong
                  
                  SELECT t.track_id FROM track t 
                  WHERE t.album_id = (
                                      SELECT t2.album_id FROM track t2
                                      WHERE t2.track_id = ifs.first_track_id
                                     )
                 ) IS NULL -- is null
             AND
                 (-- the difference between the list of tracks corresponding to each invoice in ifs
                  SELECT il2.track_id FROM invoice_line il2
                  WHERE il2.invoice_id = ifs.invoice_id
                  EXCEPT -- and the list of tracks belonging to the albums to which the tracks in ifs belong
                  SELECT t.track_id FROM track t
                  WHERE t.album_id = (
                                      SELECT t2.album_id FROM track t2
                                      WHERE t2.track_id = ifs.first_track_id
                                     ) 
                 ) IS NULL -- is null
             THEN "1" -- fill the new column of ifs is_album with 1 if the above differences are NULL (i.e., the purchases are for whole albums), and 0 if they are not (i.e., the purchases are for individual tracks)
             ELSE "0"
         END AS "is_album"
     FROM invoice_first_track ifs
    )
GROUP BY is_album;

```

## 2. Visualization
```{r}

```

## Conclusion: 
Whole albums represent approximately 20% of all sales, which is a large proportion. It doesn't make sense to change strategy and focus on buying individual popular tracks. 
